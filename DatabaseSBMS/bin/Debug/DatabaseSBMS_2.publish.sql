/*
Deployment script for DatabaseSBMS

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DatabaseSBMS"
:setvar DefaultFilePrefix "DatabaseSBMS"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL16.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL16.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[FK_Product_Unit]...';


GO
ALTER TABLE [dbo].[Products] DROP CONSTRAINT [FK_Product_Unit];


GO
PRINT N'Dropping [dbo].[FK_Product_Category]...';


GO
ALTER TABLE [dbo].[Products] DROP CONSTRAINT [FK_Product_Category];


GO
PRINT N'Dropping [dbo].[FK_ProductDetails_Products]...';


GO
ALTER TABLE [dbo].[ProductsDetails] DROP CONSTRAINT [FK_ProductDetails_Products];


GO
PRINT N'Starting rebuilding table [dbo].[Products]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Products] (
    [Id]          INT           NOT NULL,
    [barCode]     INT           NOT NULL,
    [name]        NVARCHAR (50) NOT NULL,
    [description] NVARCHAR (50) NOT NULL,
    [unitId]      INT           NOT NULL,
    [cateId]      INT           NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC),
    UNIQUE NONCLUSTERED ([barCode] ASC),
    UNIQUE NONCLUSTERED ([name] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Products])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Products] ([Id], [barCode], [name], [description], [unitId], [cateId])
        SELECT   [Id],
                 [barCode],
                 [name],
                 [description],
                 [unitId],
                 [cateId]
        FROM     [dbo].[Products]
        ORDER BY [Id] ASC;
    END

DROP TABLE [dbo].[Products];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Products]', N'Products';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating unnamed constraint on [dbo].[CustCategory]...';


GO
ALTER TABLE [dbo].[CustCategory]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Customers]...';


GO
ALTER TABLE [dbo].[Customers]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Employees]...';


GO
ALTER TABLE [dbo].[Employees]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[JobTitle]...';


GO
ALTER TABLE [dbo].[JobTitle]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[MonyState]...';


GO
ALTER TABLE [dbo].[MonyState]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Permission]...';


GO
ALTER TABLE [dbo].[Permission]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[ProductCategory]...';


GO
ALTER TABLE [dbo].[ProductCategory]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[ProdUnits]...';


GO
ALTER TABLE [dbo].[ProdUnits]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[SupCategory]...';


GO
ALTER TABLE [dbo].[SupCategory]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Suppliers]...';


GO
ALTER TABLE [dbo].[Suppliers]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Users]...';


GO
ALTER TABLE [dbo].[Users]
    ADD UNIQUE NONCLUSTERED ([name] ASC);


GO
PRINT N'Creating unnamed constraint on [dbo].[Users]...';


GO
ALTER TABLE [dbo].[Users]
    ADD UNIQUE NONCLUSTERED ([password] ASC);


GO
PRINT N'Creating [dbo].[FK_Product_Unit]...';


GO
ALTER TABLE [dbo].[Products] WITH NOCHECK
    ADD CONSTRAINT [FK_Product_Unit] FOREIGN KEY ([unitId]) REFERENCES [dbo].[ProdUnits] ([Id]);


GO
PRINT N'Creating [dbo].[FK_Product_Category]...';


GO
ALTER TABLE [dbo].[Products] WITH NOCHECK
    ADD CONSTRAINT [FK_Product_Category] FOREIGN KEY ([cateId]) REFERENCES [dbo].[ProductCategory] ([Id]);


GO
PRINT N'Creating [dbo].[FK_ProductDetails_Products]...';


GO
ALTER TABLE [dbo].[ProductsDetails] WITH NOCHECK
    ADD CONSTRAINT [FK_ProductDetails_Products] FOREIGN KEY ([prodId]) REFERENCES [dbo].[Products] ([Id]);


GO
PRINT N'Altering [dbo].[CreateCustomersTables]...';


GO
ALTER PROCEDURE [dbo].[CreateCustomersTables]
AS
Begin
CREATE TABLE [dbo].[CustCategory]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(10) NOT NULL UNIQUE, 
    [description] NVARCHAR(50) NOT NULL
);
CREATE TABLE [dbo].[Customers]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [NIC] INT NOT NULL, 
    [birthDate] DATE NOT NULL, 
    [address] NVARCHAR(50) NOT NULL, 
    [phone] NVARCHAR(50) NOT NULL,
    [cateId] INT NOT NULL, 
    [genId] INT NOT NULL,
    CONSTRAINT [FK_Customers_Category] FOREIGN KEY([cateId]) REFERENCES [dbo].[CustCategory] ([Id]),
    CONSTRAINT [FK_Customers_Gender] FOREIGN KEY([genId]) REFERENCES [dbo].[Gender] ([Id])
);
End
GO
PRINT N'Altering [dbo].[CreateEmpTables]...';


GO
ALTER PROCEDURE [dbo].[CreateEmpTables]
AS
Begin
CREATE TABLE [dbo].[JobTitle]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [description] NVARCHAR(50) NOT NULL
);

CREATE TABLE [dbo].[Employees]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [NIC] INT NOT NULL, 
    [birthDate] DATE NOT NULL, 
    [address] NVARCHAR(50) NOT NULL, 
    [jobTitleId] INT NOT NULL, 
    [basicSalary] REAL NOT NULL,
    [genderId] INT NOT NULL,
    [phone] NVARCHAR(50) NOT NULL, 
    [note] NVARCHAR(50) NOT NULL,
    CONSTRAINT [FK_Employees_SalesOp] FOREIGN KEY([jobTitleId]) REFERENCES [dbo].[JobTitle] ([Id]),
    CONSTRAINT [FK_Employees_Gender] FOREIGN KEY([genderId]) REFERENCES [dbo].[Gender] ([Id])
);

INSERT INTO [dbo].[JobTitle] ([dbo].[JobTitle].[name],[dbo].[JobTitle].[description]) VALUES ('Owner','Owner');
INSERT INTO [dbo].[Employees] (
            [dbo].[Employees].[name],
            [dbo].[Employees].[NIC],
            [dbo].[Employees].[birthDate],
            [dbo].[Employees].[address],
            [dbo].[Employees].[jobTitleId],
            [dbo].[Employees].[basicSalary],
            [dbo].[Employees].[genderId],
            [dbo].[Employees].[phone],
            [dbo].[Employees].[note]
            )VALUES(
            'Owner',
            1000001,
            '2000-1-1',
            'no place',
            1,
            0,
            1,
            '+967',
            'Owner'
            );
End
GO
PRINT N'Altering [dbo].[CreateGTables]...';


GO

ALTER PROCEDURE [dbo].[CreateGTables]
AS
Begin

CREATE TABLE [dbo].[Gender]
(
	[Id] INT NOT NULL PRIMARY KEY , 
    [name] NVARCHAR(10) NOT NULL
);
CREATE TABLE [dbo].[MonyState]
(
	[Id] INT NOT NULL PRIMARY KEY , 
    [name] NVARCHAR(10) NOT NULL UNIQUE,
	[description] NVARCHAR(20) NOT NULL
);

INSERT INTO [dbo].[Gender] ([dbo].[Gender].Id,[dbo].[Gender].name) VALUES(1,'Male');
INSERT INTO [dbo].[Gender] ([dbo].[Gender].Id,[dbo].[Gender].name) VALUES(2,'Female');

INSERT INTO [dbo].[MonyState]  VALUES(1,'Cash','نقدا');
INSERT INTO [dbo].[MonyState]   VALUES(2,'Later','آجل');
INSERT INTO [dbo].[MonyState]  VALUES(3,'Pay','تم السداد');

End
GO
PRINT N'Altering [dbo].[CreateStoresTables]...';


GO
ALTER PROCEDURE [dbo].[CreateStoresTables]
AS
Begin
CREATE TABLE [dbo].[ProductCategory]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [description]  NVARCHAR(50) NOT NULL
);
CREATE TABLE [dbo].[ProdUnits]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(10) NOT NULL UNIQUE, 
    [symbole] NVARCHAR(5) NOT NULL, 
    [subUName] NVARCHAR(10) NOT NULL, 
    [subSymbole] NVARCHAR(5) NOT NULL, 
    [description] NVARCHAR(50) NOT NULL,
    [rateMB] INT NOT NULL
);
CREATE TABLE [dbo].[Products]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [barCode] INT NOT NULL UNIQUE, 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [description] NVARCHAR(50) NOT NULL, 
    [unitId] INT NOT NULL, 
    [cateId] INT NOT NULL,
    CONSTRAINT [FK_Product_Unit] FOREIGN KEY([unitId]) REFERENCES [dbo].[ProdUnits] ([Id]),
    CONSTRAINT [FK_Product_Category] FOREIGN KEY([cateId]) REFERENCES [dbo].[ProductCategory] ([Id])
);
CREATE TABLE [dbo].[ProductsDetails]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [prodId] INT NOT NULL, 
    [cost] REAL NOT NULL, 
    [price] REAL NOT NULL, 
    [quantity] REAL NOT NULL,
    [ProdExpireDate] DATE NOT NULL, 
    [storeDate] DATE NOT NULL,
    CONSTRAINT [FK_ProductDetails_Products] FOREIGN KEY([prodId]) REFERENCES [dbo].[Products] ([Id]),
);

End
GO
PRINT N'Altering [dbo].[CreateSuppliersTables]...';


GO
ALTER PROCEDURE [dbo].[CreateSuppliersTables]
AS
Begin
CREATE TABLE [dbo].[SupCategory]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(10) NOT NULL UNIQUE, 
    [description] NVARCHAR(50) NOT NULL
);
CREATE TABLE [dbo].[Suppliers]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [cateId] INT NOT NULL, 
    [name] NVARCHAR(50) NOT NULL UNIQUE, 
    [address] NVARCHAR(50) NOT NULL, 
    [phone] NVARCHAR(50) NOT NULL,
    CONSTRAINT [FK_Suppliers_Category] FOREIGN KEY([cateId]) REFERENCES [dbo].[SupCategory] ([Id])
)
End
GO
PRINT N'Altering [dbo].[CreateUsersTableas]...';


GO
ALTER PROCEDURE [dbo].[CreateUsersTableas]
AS
Begin

CREATE TABLE [dbo].[Permission]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(10) NOT NULL UNIQUE
);
INSERT INTO [dbo].[Permission] ([dbo].[Permission].name)VALUES('Owner');
INSERT INTO [dbo].[Permission] ([dbo].[Permission].name)VALUES('Admin');
INSERT INTO [dbo].[Permission] ([dbo].[Permission].name)VALUES('SaleSt');
INSERT INTO [dbo].[Permission] ([dbo].[Permission].name)VALUES('PurchaseSt');
CREATE TABLE [dbo].[Users]
(
	[Id] INT NOT NULL PRIMARY KEY IDENTITY(1,1), 
    [name] NVARCHAR(10) NOT NULL UNIQUE, 
    [password] NVARCHAR(10) NOT NULL UNIQUE, 
    [empId] INT NOT NULL, 
    [permId] INT NOT NULL,
    CONSTRAINT [FK_Users_Emp] FOREIGN KEY([empId]) REFERENCES [dbo].[Employees] ([Id]),
    CONSTRAINT [FK_Users_Perm] FOREIGN KEY([permId]) REFERENCES [dbo].[Permission] ([Id])
);
INSERT INTO [dbo].[Users] (
            [dbo].[Users].name,
            [dbo].[Users].password,
            [dbo].[Users].empId,
            [dbo].[Users].permId
            )VALUES(
            'Owner',
            'Owner',
            1,1
            );

End
GO
PRINT N'Refreshing [dbo].[AddProduct]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[AddProduct]';


GO
PRINT N'Refreshing [dbo].[DeleteProduct]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[DeleteProduct]';


GO
PRINT N'Refreshing [dbo].[FilterAsProdCategory]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[FilterAsProdCategory]';


GO
PRINT N'Refreshing [dbo].[GetProducts]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[GetProducts]';


GO
PRINT N'Refreshing [dbo].[GetPurchaseItems]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[GetPurchaseItems]';


GO
PRINT N'Refreshing [dbo].[GetSaleItems]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[GetSaleItems]';


GO
PRINT N'Refreshing [dbo].[GetSaleProducts]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[GetSaleProducts]';


GO
PRINT N'Refreshing [dbo].[SearchProdDetails]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SearchProdDetails]';


GO
PRINT N'Refreshing [dbo].[SearchProduct]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[SearchProduct]';


GO
PRINT N'Refreshing [dbo].[UpdateProduct]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[UpdateProduct]';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Products] WITH CHECK CHECK CONSTRAINT [FK_Product_Unit];

ALTER TABLE [dbo].[Products] WITH CHECK CHECK CONSTRAINT [FK_Product_Category];

ALTER TABLE [dbo].[ProductsDetails] WITH CHECK CHECK CONSTRAINT [FK_ProductDetails_Products];


GO
PRINT N'Update complete.';


GO
